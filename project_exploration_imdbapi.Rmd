---
title: "DWH Project"
author: "Varshini Yanamandra"
date: "2023-04-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(httr)
library(curl)
library(jsonlite)
library(RCurl)
library(ggplot2)
library(tidytext)
library(textdata)
library(stringr)
```

ANALYSIS OF A FEW MARVEL AND DC MOVIES USING IMDB DATA

This section gets information from the OMDB API for 5 film series each from the Marvel Comic Universe and the DC universe. The film series chosen are:

Marvel Comic Universe:
1. Captain America
2. Iron Man
3. Thor
4. Spider-Man
5. The Hulk

DC:
1. Wonder Woman
2. Batman (The Dark Knight Trilogy)
3. Superman
4. Aquaman
5. Shazam!

The data is collected for the movies that have been released, as of date.

```{r}
# Getting IMDb movie IDs from the IMDb websites. This was done manually.
# The IDs of films belonging to separate film series are put in separate lists.

# MARVEL
capt.america <- c("tt0458339", "tt1843866", "tt3498820")
iron.man <- c("tt0371746", "tt1228705", "tt1300854")
thor <- c("tt0800369", "tt1981115", "tt3501632", "tt10648342")
spiderman <- c("tt0145487", "tt0316654", "tt0413300", "tt2250912", "tt6320628", "tt10872600")
hulk <- c("tt0286716", "tt0800080")

# DC
wonder.woman <- c("tt0451279", "tt7126948")
batman.dkt <- c("tt0372784", "tt0468569", "tt1345836") # The Dark Knight Trilogy
superman <- c("tt0348150", "tt0770828")
aquaman <- c("tt1477834") #, "tt9663764")
shazam <- c("tt0448115", "tt10151854")
```

Once we have the IMDb movie IDs for the movies, we use the OMDB API to extract whatever information is available for each film. An API key was obtained for the OMDB API through their website (www.omdbapi.com). This API key has been used to make requests to the API.

```{r}
# API key obtained through the website
mykey = "4ce5d1e6"
# The base URL to access the API and make requests to it
baseurl <- "http://www.omdbapi.com"

# joining the movies by comic universe to create 
# comprehensive lists for all the selected Marvel and DC films
marvel <- c(capt.america, iron.man, thor, spiderman, hulk)
dc <- c(wonder.woman, batman.dkt, superman, aquaman, shazam)

# getting API response for all Marvel films
Marvel <- rep("", length(marvel))
for (i in 1:length(marvel)) {
  Marvel[i] <- getForm(uri = baseurl, apikey = mykey, i = marvel[i])
}
# getting API response for all DC films
DC <- rep("", length(dc))
for (i in 1:length(dc)) {
  DC[i] <- getForm(uri = baseurl, apikey = mykey, i = dc[i])
}
```

```{r}
# creating summary dataframes

## the response received from the API is in the form of JSON objects
## we use fromJSON() to parse the JSON objects and convert these responses into named lists

## we start off by creating an empty dataframe with 0 rows and 
## number of columns equal to the number of keys in the JSON response
marvel.summary <- data.frame(matrix(ncol = 25, nrow = 0)) # fromJSON() response has 25 attributes
colnames(marvel.summary) <- Marvel[1] %>% fromJSON() %>% names() # getting the names from the named lists

## populating the Marvel dataframe with information from the API
for (i in 1:length(Marvel)) {
  ## this line of code puts the JSON response into the form of a dataframe row
  marvel.summary.temp <- do.call("cbind", fromJSON(Marvel[i]))
  ## binding the information on the current movie with all the movies we have so far
  marvel.summary <- rbind(marvel.summary, marvel.summary.temp)
}

marvel.summary %>% head() # need to pivot wider
# pivot wider
marvel.summary <- pivot_wider(marvel.summary, names_from = Ratings.Source, values_from = Ratings.Value)
marvel.summary %>% head()

# repeating the same thing to create a summary dataframe for DC movies
dc.summary <- data.frame(matrix(ncol = 25, nrow = 0))
colnames(dc.summary) <- DC[1] %>% fromJSON() %>% names()

for (i in 1:length(DC)) {
  dc.summary.temp <- do.call("cbind", fromJSON(DC[i]))
  dc.summary <- rbind(dc.summary, dc.summary.temp)
}

dc.summary %>% head() # need to pivot wider
dc.summary <- pivot_wider(dc.summary, names_from = Ratings.Source, values_from = Ratings.Value)
dc.summary %>% head()
```

This next section deals with processing the data obtained from the API. Data has been cleaned, for example, by removing commas, '$' and '%' signs, and converting character-type columns with numeric values to double-type columns. Details of award nominations and wins have been extracted from the 'Awards' column using Regular Expressions (RegEx).

```{r}
# DATA PROCESSING

# adding a new column to both the dataframes 
# to identify which universe a movie belongs to
marvel.summary$Universe <- rep("Marvel", dim(marvel.summary)[1])
dc.summary$Universe <- rep("DC", dim(dc.summary)[1])

# combining the two dataframes into one for ease of analysis
movies <- rbind(marvel.summary, dc.summary)

l = dim(movies)[1] # total number of movies
# creating lists to hold the values extracted using RegEx
movies.wins <- rep("", l) # total wins
movies.noms <- rep("", l) # total nominations
movies.Owins <- rep("", l) # Oscar wins
movies.Onoms <- rep("", l) # Oscar nominations

# the award nomination and win information is extracted for each movie using a loop
# and the values are stored in the corresponding lists
for (i in 1:l) {
  movies.wins[i] = str_extract(str_extract(movies$Awards[i], "[0-9]+ win"), "[0-9]+") # extract number of wins
  movies.noms[i] = str_extract(str_extract(movies$Awards[i], "[0-9]+ nomination"), "[0-9]+") # extract number of nominations
  movies.Onoms[i] = str_extract(str_extract(movies$Awards[i], "Nominated for [0-9]+ Oscar"), "[0-9]+") # extract number of Oscar nominations
  movies.Owins[i] = str_extract(str_extract(movies$Awards[i], "Won [0-9]+ Oscar"), "[0-9]+") # extract number of Oscar wins
}

# adding the values in these lists to the dataframe as new columns
movies$Wins = movies.wins
movies$Nominations = movies.noms
movies$OscarWins = movies.Owins
movies$OscarNominations = movies.Onoms

# some more processing
# this processing allows us to convert the character-type columns to numeric-type in the next step
movies$imdbVotes <- gsub(",", "", movies$imdbVotes) # removing commas in the number of votes column
movies$BoxOffice <- gsub(",", "", movies$BoxOffice) # removing commas in the box office collections column
# the '$' sign has been enclosed in square brackets in order to let R identify it as a character
# and not as the special character it is generally used as
# this is similar to 'escaping' the special character '$'
movies$BoxOffice <- gsub("[$]", "", movies$BoxOffice) # removing the '$' sign in the box office collections column
movies$Runtime <- gsub(" min", "", movies$Runtime) # removing the ' min' suffix after the movie runtime
movies$`Internet Movie Database` <- gsub("/10", "", movies$`Internet Movie Database`) # removing the denominator for IMD ratings
# the '%' sign is yet another special character
# so it has been enclosed in square brackets to escape it
movies$`Rotten Tomatoes` <- gsub("[%]", "", movies$`Rotten Tomatoes`) # removing the '%' sign in Rotten Tomatoes ratings
movies$Metacritic <- gsub("/100", "", movies$Metacritic) # removing the denominator for Metacritic ratings

# replacing 'NA' with 0 and converting the columns to numeric types
movies <- movies %>% mutate_at(c(5, 15:17, 21, 25:27, 29:32), ~replace_na(., "0")) %>% mutate_at(c(5, 15:17, 21, 25:27, 29:32), as.numeric)
movies %>% head()

# some cells where the numeric field values were "N/A" will be coerced to NA when using as.numeric() - this is ok, since they are null values originally. None of the numeric values are being lost.
```

After taking a look at the structure of the processed data, it can be seen that not all the columns are necessary for further analysis. There are also some columns that have redundant (repeated) values; for example, the columns 'imdbRating' and 'Internet Movie Database' have the same information. Columns 'Metascore' and 'Metacritic' also contain the same information. Only one out of each set of repeated data columns is kept, and the others are removed.

The final columns chosen are:
1. Title (column index 1)
2. Runtime (5)
3. Plot (10)
4. imdbRating (16)
5. imdbVotes (17)
6. BoxOffice (21)
7. Rotten Tomatoes (26)
8. Metacritic (27)
9. Universe (28)
10. Wins (29)
11. Nominations (30)
12. OscarWins (31)
13. OscarNominations (32)

```{r}
# selecting only the columns needed for further analysis
movies <- movies[, c(1, 5, 10, 16:17, 21, 26:32)]
head(movies, 3)
```

Now that we have our data in its final form, we will start visualizing the data in order to draw some inferences from the data.

The first plot is a column plot that we use to compare the runtimes of all of the movies. The columns have been filled based on which universe the film belongs to. The plot has been arranged in the decreasing order of runtime.

```{r}
# plot 1: comparing the runtimes of all the films
ggplot(movies, aes(Runtime, reorder(Title, Runtime), # ordering the titles according to their runtimes
                   fill = Universe)) +
  geom_col() + # column plot
  ggtitle("Runtime of Selected Marvel and DC Movies") + # plot title
  labs(y = "Movie", x = "Runtime (in minutes)") # x and y titles
```

From this plot, we can see that most DC movies have a longer runtime when compared to Marvel movies, in the 10 movie series we have chosen. We also see that in the DC universe movies, the 'Shazam!' films have the lowest runtimes.

The next few plots help us visualize the ratings of each movie from IMDb, Rotten Tomatoes and Metacritic. These plots, are again, column plots. All these plots have been arranged in the decreasing order of ratings and filled based on which universe the movies belong to.

```{r}
# plot 2: comparing the IMDb ratings for all the selected movies
ggplot(movies, aes(imdbRating, reorder(Title, imdbRating), # ordering the titles in order of ratings
                   fill = Universe)) + # filling the columns based on the universe
  geom_col() + # column plot
  labs(y = "Movie", x = "IMDb Rating (out of 10)") + # adding custom axis titles
  ggtitle("IMDb Ratings") # adding the plot title

# plot 3: comparing the Rotten Tomatoes ratings for all the selected movies
ggplot(movies, aes(`Rotten Tomatoes`, reorder(Title, `Rotten Tomatoes`), fill = Universe)) +
  geom_col() + labs(y = "Movie", x = "Rotten Tomatoes Rating (in %)") + ggtitle("Rotten Tomatoes Ratings")

# plot 4: comparing the Metacritic ratings for all the selected movies
ggplot(movies, aes(Metacritic, reorder(Title, Metacritic), fill = Universe)) +
  geom_col() + labs(y = "Movie", x = "Metacritic Rating (out of 100)") + ggtitle("Metacritic Score")
```

Based on these 3 ratings, we can't say that movies of one Universe do better than another. The rankings of the movies varies based on which rating source we use. Interestingly, 'The Dark Knight' is the best rated movie across all three rating sources! We can also see that two movies - Spider-Man: No Way Home and Captain America: Civil War - have no ratings on Rotten Tomatoes.

Let us now take the 6 movies from the Spider-Man film series and perform some analysis.
The plot generated compares the runtime of each movie with the Metacritic ratings and box office earnings. Each line is colored differently in order to make the graph easy to interpret. The colors have clearly been labelled in the legend. The x-axis labels have been rotated to appear vertically since they will overlap if shown horizontally.

```{r}
# grepl() allows us to filter titles that have the string "Spider-Man" in them
spidey <- filter(movies, grepl("Spider-Man", Title)) 
# take a look at the obtained dataset to confirm if it is correct
spidey # these are in order of their release dates

# plot 5: comparing the Metacritic ratings, the runtime and the box office collections
ggplot(spidey) +
  # adding line and point plots of the Metacritic ratings
  geom_line(mapping = aes(Title, Metacritic, group = 1, color = "Metacritic Rating (out of 100)")) + # line plot
  geom_point(mapping = aes(Title, Metacritic, group = 1, color = "Metacritic Rating (out of 100)")) + # plot each point
  # adding line and point plots of the Runtime
  geom_line(mapping = aes(Title, Runtime, group = 1, color = "Runtime (in minutes)")) + 
  geom_point(mapping = aes(Title, Runtime, group = 1, color = "Runtime (in minutes)")) + 
  # adding line and point plots of the Box Office earning
  # the earnings have been divided by 10,000,000 in order to bring them on scale with the other two plots
  geom_line(mapping = aes(Title, BoxOffice/10000000, group = 1, color = "Box Office Collection (in 10^7 dollars)")) + geom_point(mapping = aes(Title, BoxOffice/10000000, group = 1, color = "Box Office Collection (in 10^7 dollars)")) + theme(axis.text.x = element_text(angle = 90)) + # rotating the x-axis labels by 90 degrees
  ggtitle("Comparing Runtime with Metacritic Ratings and Box Office Collections") + # plot title
  xlab("Movie") + ylab("Value") # axis titles
```

Interestingly, we see that the Metacritic ratings generally go down with increasing runtimes and vice-versa. This is not strictly the case, however! Spider-Man 2 is also the highest-rated movie of the series, based on Metacritic ratings. There is no noticeable trend in the box office earnings. 
It is noted that there is an extreme increase in the earnings of 'Spider-Man: No Way Home' compared to the other films in the series. This could be because it was released just as COVID restrictions were being lifted, which made people more excited than normal to watch the film in theatres after being cooped up at home for around two years.

The next plot compares the award wins and nominations received by each of the six Spider-Man movies. Oscar wins and nominations have also been included. Each line has a different color, and has labelled clearly.

```{r}
# plot 6: comparing award wins and nominations
ggplot(spidey) +
  # plotting total award nominations
  geom_line(aes(Title, Nominations, group = 1, color = "Nominations")) + # line plot
  geom_point(aes(Title, Nominations, group = 1, color = "Nominations")) + # plotting every point
  # plotting total award wins
  geom_line(aes(Title, Wins, group = 1, color = "Wins")) + # line plot
  geom_point(aes(Title, Wins, group = 1, color = "Wins")) + # plotting every point
  # plotting Oscar nominations
  geom_line(aes(Title, OscarNominations, group = 1, color = "Oscar Nominations")) + # line plot
  geom_point(aes(Title, OscarNominations, group = 1, color = "Oscar Nominations")) + # plotting every point
  # plotting Oscar wins
  geom_line(aes(Title, OscarWins, group = 1, color = "Oscar Wins")) + # line plot
  geom_point(aes(Title, OscarWins, group = 1, color = "Oscar Wins")) + # plotting every point
  theme(axis.text.x = element_text(angle = 90)) + # rotating the x-axis labels by 90 degrees
  ggtitle("Award Statistics of Spider-Man Movies") + # plot title
  xlab("Movie") + ylab("Number") # x and y-axis titles
```

Spider-Man: Homecoming seems to have done the worst in terms of both wins and nominations for awards, while the next movie, Spider-Man: No Way Home did the best.
Spider-Man 2 seems to have an Oscar win without an Oscar nomination, which is not possible! On doing an internet search, the film actually received 3 Oscar nominations, making it both the film in the series with the highest Oscar nominations and wins. This is due to the way we extracted the information using Regular Expressions. The description from OMDB only said "Won 1 Oscar."

The next plot is a bar plot that compares the IMDb votes received by each of the selected movies. The movies are ordered in the increasing order of votes received.

```{r}
# plot 7: comparing IMDb votes received by all selected movies
ggplot(movies, aes(reorder(Title, imdbVotes), imdbVotes, fill = Universe)) +
  geom_bar(stat = "identity") + # bar plot
  theme(axis.text.x = element_text(angle = 90)) + # rotating the x-axis labels by 90 degrees
  ggtitle("IMDb Votes") + # plot title
  xlab("Movie") + ylab("IMDb Votes") # axis titles
```

The top 3 movies based on votes are all DC movies, and are also all Batman movies. The difference between the number of votes for the movies at place 3 (Batman Begins) and place 4 (Iron Man) is huge! The second Batman movie (The Dark Knight) is the most voted film out of all the selected films.

Let us do the same analysis for just the Spider-Man movies, by creating a pie chart to compare the relative number of votes. We will not use the actual numbers. Instead, we will simply rank the movies based on the number of votes they received. The slices of the pie-chart are ordered based on the number of votes received.

```{r}
# plot 8: IMDb votes received by Spider-Man movies
ggplot(spidey, aes(x = reorder(Title, imdbVotes), y = imdbVotes, fill = Title)) + # ordering based on votes received
  geom_bar(stat = "identity") + # start it off as a bar plot
  coord_polar("x", start = 0) + # convert the plot to a 'polar' plot: pie chart creation
  theme_void() + # removing the background, grid and axes
  ggtitle("Pie Chart of IMDb Votes Received by Spider-Man Movies") # title of the plot
```

Based on the pie chart, we can see that the ranking is (decreasing order of votes received):
1. Spider-Man
2. Spider-Man: No Way Home
3. Spider-Man: Homecoming
4. Spider-Man 2
5. Spider-Man 3
6. Spider-Man: Far from Home

The next section deals with sentiment analysis of the movie plots, as given on IMDb. We start off using the "Bing" lexicon, which simply classifies words into inducing 'positive' and 'negative' sentiments.

```{r}
# sentiment analysis using the Bing lexicon
bing <- get_sentiments("bing") # getting the Bing lexicon data
names(movies)

# columns chosen for sentiment analysis:
## 1. Title (column 1)
## 2. Plot (3)
## 3. Universe (9)
plots <- movies[, c(1, 3, 9)] # choosing the columns required for sentiment analysis
# tokenizing each word in the 'Plot' columns and joining the result with the bing lexicon sentiments
plots <- plots %>% unnest_tokens(word, Plot) %>% inner_join(bing) # join by 'word'
# counting the number of words for each sentiment, for each universe
plots <- plots %>% count(Universe, sentiment)

p1 <- plots %>% filter(Universe == "DC") # filtering out only the DC movies
word_sum_dc = sum(p1$n) # getting the total number of words in DC movies' plots
p1 <- plots %>% filter(Universe == "Marvel") # filtering out only the Movie movies
word_sum_marvel = sum(p1$n) # getting the total number of words in Marvel movies' plots

# adding a new column containing the proportion of words in each sentiment for the DC movies
plots <- plots %>% mutate(prop_sentiment = n/word_sum_dc) 
# doing the same for Marvel movies
plots$prop_sentiment[3:4] <- plots$n[3:4]/word_sum_marvel

# plot 9: Bing sentiment plot
# the bars are in the decreasing order of proportion of sentiment
ggplot(plots, aes(x = prop_sentiment, y = reorder(sentiment, prop_sentiment), fill = Universe)) +
  geom_bar(stat = "identity", position = "dodge") + # bar plot
  ggtitle("Bing Sentiment Analysis for MCU and DC Movie Plots - Collective") + # plot title
  xlab("Proportion of sentiment") + ylab("Sentiment") # axis titles
```

We can see that there is a very high proportion of negative sentiments when compared to positive sentiments for both the universes. DC seems to have a higher proportion of positive sentiment in their plots, generally, when compared to Marvel. To get more clarity, let us use the nrc lexicon for a detailed analysis of the sentiments. 

We then look into more detailed sentiments using the 'NRC' lexicon.

```{r}
nrc <- get_sentiments("nrc") # getting the 'nrc' lexicon information

# repeating the same steps as done with the Bing lexicon
plots <- movies[, c(1, 3, 9)] # choosing the required columns
plots <- plots %>% unnest_tokens(word, Plot) %>% inner_join(nrc) # tokenizing by word and joining with the lexicon table
plots <- plots %>% count(Universe, sentiment) # getting the totals of each sentiment in each Universe
# removing generic 'positive' and 'negative' sentiments
plots <- plots %>% filter(sentiment != "positive", sentiment != "negative")

p1 <- plots %>% filter(Universe == "DC")
word_sum_dc = sum(p1$n)
p1 <- plots %>% filter(Universe == "Marvel")
word_sum_marvel = sum(p1$n)
plots <- plots %>% mutate(prop_sentiment = n/word_sum_dc) # proportion of sentiments for DC movies
plots$prop_sentiment[9:16] <- plots$n[9:16]/word_sum_marvel # proportion of sentiments for Marvel movies

# plot 10: NRC sentiment plot, ordered in decreasing order of proportion of sentiment
ggplot(plots, aes(x = prop_sentiment, y = reorder(sentiment, prop_sentiment), fill = Universe)) +
  geom_bar(stat = "identity", position = "dodge") + # bar plot
  ggtitle("NRC Sentiment Analysis for MCU and DC Movie Plots - Collective") + # plot title
  xlab("Proportion of Sentiment") + ylab("Sentiment") # axis titles
```

Both universes heavily use words that imply fear and anger. Marvel uses more fear-related words compared to DC, while DC uses more anger-related words when compared to Marvel. Marvel has more words that relate to trust, sadness and disgust when compared to DC. DC has a significantly higher proportion of words that relate to joy and surprise, when compared to Marvel.